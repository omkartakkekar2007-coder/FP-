// MilkDairyApp.jsx
// Single-file React frontend (Vite-compatible). Exports default App component.
// Features:
// - Login (demo credentials: demo / demo123)
// - Inventory management (add/edit/delete)
// - Record daily sales (ties to inventory and reduces quantity)
// - Simple today's summary
// - Works in MOCK mode (localStorage) or uses a real API if you set USE_MOCK=false and provide API_BASE

import React, { useEffect, useState } from 'react';

// ---------- CONFIG ----------
const USE_MOCK = true; // set to false to call a real backend
const API_BASE = 'http://localhost:4000/api';
// ----------------------------

// ---------- Simple API layer (mock or real) ----------
const mockKey = 'milk_dairy_mock_v1';
function ensureMockData(){
  const raw = localStorage.getItem(mockKey);
  if (raw) return JSON.parse(raw);
  const init = {
    shops: [{ id: 1, name: 'Demo Dairy', username: 'demo', password: 'demo123' }],
    inventory: [
      { id: 1, shop_id: 1, item_name: 'Cow Full Cream', unit: 'litre', quantity: 50, price_per_unit: 60 },
      { id: 2, shop_id: 1, item_name: 'Buffalo Milk', unit: 'litre', quantity: 30, price_per_unit: 70 }
    ],
    sales: []
  };
  localStorage.setItem(mockKey, JSON.stringify(init));
  return init;
}

async function apiLogin(username, password){
  if (!USE_MOCK) {
    const res = await fetch(`${API_BASE}/login`, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ username, password }) });
    return res.json();
  }
  const data = ensureMockData();
  const shop = data.shops.find(s => s.username === username && s.password === password);
  if (!shop) return { error: 'Invalid credentials' };
  return { shop: { id: shop.id, name: shop.name, username: shop.username } };
}

async function apiGetInventory(shop_id){
  if (!USE_MOCK) {
    const res = await fetch(`${API_BASE}/inventory?shop_id=${shop_id}`);
    return res.json();
  }
  const data = ensureMockData();
  return data.inventory.filter(i => i.shop_id === Number(shop_id));
}

async function apiAddInventory(payload){
  if (!USE_MOCK) {
    const res = await fetch(`${API_BASE}/inventory`, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload) });
    return res.json();
  }
  const data = ensureMockData();
  const id = (data.inventory.map(i=>i.id).reduce((a,b)=>Math.max(a,b),0) || 0) + 1;
  const rec = { id, ...payload };
  data.inventory.push(rec);
  localStorage.setItem(mockKey, JSON.stringify(data));
  return rec;
}

async function apiUpdateInventory(id, payload){
  if (!USE_MOCK) {
    const res = await fetch(`${API_BASE}/inventory/${id}`, { method: 'PUT', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload) });
    return res.json();
  }
  const data = ensureMockData();
  const idx = data.inventory.findIndex(x => x.id === Number(id));
  if (idx === -1) return { error: 'Not found' };
  data.inventory[idx] = { ...data.inventory[idx], ...payload };
  localStorage.setItem(mockKey, JSON.stringify(data));
  return data.inventory[idx];
}

async function apiDeleteInventory(id){
  if (!USE_MOCK) {
    const res = await fetch(`${API_BASE}/inventory/${id}`, { method: 'DELETE' });
    return res.json();
  }
  const data = ensureMockData();
  data.inventory = data.inventory.filter(x => x.id !== Number(id));
  localStorage.setItem(mockKey, JSON.stringify(data));
  return { deleted: true };
}

async function apiRecordSale(payload){
  if (!USE_MOCK) {
    const res = await fetch(`${API_BASE}/sales`, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload) });
    return res.json();
  }
  const data = ensureMockData();
  const id = (data.sales.map(s=>s.id).reduce((a,b)=>Math.max(a,b),0) || 0) + 1;
  const rec = { id, ...payload, created_at: new Date().toISOString() };
  data.sales.push(rec);
  // reduce inventory
  if (rec.inventory_id){
    const inv = data.inventory.find(i => i.id === Number(rec.inventory_id));
    if (inv) inv.quantity = Math.max(0, Number(inv.quantity) - Number(rec.quantity));
  }
  localStorage.setItem(mockKey, JSON.stringify(data));
  return rec;
}

async function apiDailyReport(shop_id, date){
  if (!USE_MOCK) {
    const res = await fetch(`${API_BASE}/report/daily?shop_id=${shop_id}&date=${date}`);
    return res.json();
  }
  const data = ensureMockData();
  const sales = data.sales.filter(s => s.shop_id === Number(shop_id) && s.date === date);
  const total_qty = sales.reduce((a,b)=>a + Number(b.quantity || 0), 0);
  const total_amount = sales.reduce((a,b)=>a + Number(b.total_amount || 0), 0);
  return { date, total_qty, total_amount };
}

// ---------- UI components ----------

function Login({ onLogin }){
  const [username, setUsername] = useState('demo');
  const [password, setPassword] = useState('demo123');
  const [err, setErr] = useState('');
  const [loading, setLoading] = useState(false);

  async function submit(e){
    e.preventDefault();
    setErr('');
    setLoading(true);
    const r = await apiLogin(username, password);
    setLoading(false);
    if (r.error) setErr(r.error);
    else onLogin(r.shop);
  }

  return (
    <div className="max-w-md p-6 bg-white rounded-2xl shadow">
      <h2 className="text-2xl font-semibold mb-4">Shop Owner Login</h2>
      <form onSubmit={submit} className="space-y-3">
        <div>
          <label className="block text-sm">Username</label>
          <input className="w-full border p-2 rounded" value={username} onChange={e=>setUsername(e.target.value)} />
        </div>
        <div>
          <label className="block text-sm">Password</label>
          <input type="password" className="w-full border p-2 rounded" value={password} onChange={e=>setPassword(e.target.value)} />
        </div>
        {err && <div className="text-red-600">{err}</div>}
        <div className="flex items-center justify-between">
          <button className="px-4 py-2 bg-indigo-600 text-white rounded" disabled={loading}>{loading ? 'Logging...' : 'Login'}</button>
          <div className="text-xs text-gray-500">Demo: demo / demo123</div>
        </div>
      </form>
    </div>
  );
}

function Inventory({ shop, onInventoryChange }){
  const [items, setItems] = useState([]);
  const [form, setForm] = useState({ item_name: '', quantity: '', price_per_unit: '' });
  const [loading, setLoading] = useState(false);

  async function load(){
    setLoading(true);
    const d = await apiGetInventory(shop.id);
    setItems(d || []);
    setLoading(false);
    if (onInventoryChange) onInventoryChange(d || []);
  }

  useEffect(()=>{ load(); }, []);

  async function add(e){
    e.preventDefault();
    if (!form.item_name) return alert('Enter item name');
    await apiAddInventory({ shop_id: shop.id, item_name: form.item_name, unit: 'litre', quantity: Number(form.quantity||0), price_per_unit: Number(form.price_per_unit||0) });
    setForm({ item_name: '', quantity: '', price_per_unit: '' });
    load();
  }

  async function del(id){
    if (!confirm('Delete this item?')) return;
    await apiDeleteInventory(id);
    load();
  }

  async function edit(item){
    const newName = prompt('Item name', item.item_name);
    if (newName == null) return;
    const newQty = prompt('Quantity', String(item.quantity));
    if (newQty == null) return;
    const newPrice = prompt('Price per unit', String(item.price_per_unit));
    if (newPrice == null) return;
    await apiUpdateInventory(item.id, { item_name: newName, quantity: Number(newQty), price_per_unit: Number(newPrice) });
    load();
  }

  return (
    <div className="bg-white p-4 rounded-2xl shadow">
      <h3 className="font-semibold mb-3">Inventory</h3>
      <form onSubmit={add} className="flex gap-2 mb-3">
        <input className="flex-1 border p-2 rounded" placeholder="Item name" value={form.item_name} onChange={e=>setForm({...form, item_name: e.target.value})} />
        <input className="w-20 border p-2 rounded" placeholder="Qty" type="number" value={form.quantity} onChange={e=>setForm({...form, quantity: e.target.value})} />
        <input className="w-28 border p-2 rounded" placeholder="Price/unit" type="number" value={form.price_per_unit} onChange={e=>setForm({...form, price_per_unit: e.target.value})} />
        <button className="px-3 py-2 bg-green-600 text-white rounded">Add</button>
      </form>
      {loading ? <div>Loading...</div> : (
        <table className="w-full text-sm">
          <thead className="text-left text-gray-600"><tr><th>Item</th><th>Qty</th><th>Price</th><th>Action</th></tr></thead>
          <tbody>
            {items.map(it => (
              <tr key={it.id} className="border-t">
                <td className="py-2">{it.item_name}</td>
                <td>{it.quantity}</td>
                <td>{it.price_per_unit}</td>
                <td>
                  <button className="text-xs mr-2" onClick={()=>edit(it)}>Edit</button>
                  <button className="text-xs text-red-600" onClick={()=>del(it.id)}>Delete</button>
                </td>
              </tr>
            ))}
            {items.length === 0 && <tr><td colSpan={4} className="py-4 text-gray-500">No items yet</td></tr>}
          </tbody>
        </table>
      )}
    </div>
  );
}

function Sales({ shop, onSaleRecorded }){
  const [items, setItems] = useState([]);
  const [form, setForm] = useState({ inventory_id: '', date: new Date().toISOString().slice(0,10), quantity: '', total_amount: '' });

  async function loadItems(){
    const d = await apiGetInventory(shop.id);
    setItems(d || []);
  }
  useEffect(()=>{ loadItems(); }, []);

  async function submit(e){
    e.preventDefault();
    if (!form.inventory_id) return alert('Select an item');
    if (!form.quantity || Number(form.quantity) <= 0) return alert('Enter quantity');
    await apiRecordSale({ shop_id: shop.id, inventory_id: Number(form.inventory_id), date: form.date, quantity: Number(form.quantity), total_amount: Number(form.total_amount||0) });
    setForm({ inventory_id: '', date: new Date().toISOString().slice(0,10), quantity: '', total_amount: '' });
    loadItems();
    if (onSaleRecorded) onSaleRecorded();
    alert('Sale recorded');
  }

  return (
    <div className="bg-white p-4 rounded-2xl shadow">
      <h3 className="font-semibold mb-3">Record Sale</h3>
      <form onSubmit={submit} className="space-y-2">
        <div>
          <select className="w-full border p-2 rounded" value={form.inventory_id} onChange={e=>setForm({...form, inventory_id: e.target.value})}>
            <option value="">-- select item --</option>
            {items.map(it => <option key={it.id} value={it.id}>{it.item_name} (avail {it.quantity})</option>)}
          </select>
        </div>
        <div className="flex gap-2">
          <input type="date" className="border p-2 rounded" value={form.date} onChange={e=>setForm({...form,date:e.target.value})} />
          <input type="number" className="border p-2 rounded" placeholder="Quantity" value={form.quantity} onChange={e=>setForm({...form,quantity:e.target.value})} />
          <input type="number" className="border p-2 rounded" placeholder="Total amount" value={form.total_amount} onChange={e=>setForm({...form,total_amount:e.target.value})} />
        </div>
        <div>
          <button className="px-4 py-2 bg-indigo-600 text-white rounded">Record</button>
        </div>
      </form>
    </div>
  );
}

// ---------- Main App ----------

export default function App(){
  const [shop, setShop] = useState(null);
  const [report, setReport] = useState(null);
  const [inventoryList, setInventoryList] = useState([]);

  useEffect(()=>{
    if (shop){ loadReport(); }
  }, [shop]);

  async function loadReport(){
    const d = await apiDailyReport(shop.id, new Date().toISOString().slice(0,10));
    setReport(d);
  }

  if (!shop) return (
    <div className="min-h-screen bg-gray-50 p-8">
      <div className="max-w-4xl mx-auto">
        <h1 className="text-3xl font-bold mb-6">Local Milk Dairy — Frontend</h1>
        <Login onLogin={s => setShop(s)} />
      </div>
    </div>
  );

  return (
    <div className="min-h-screen bg-gray-50 p-8">
      <div className="max-w-6xl mx-auto">
        <div className="flex items-center justify-between mb-6">
          <div>
            <h2 className="text-2xl font-bold">{shop.name}</h2>
            <div className="text-sm text-gray-600">ID: {shop.id} • {shop.username}</div>
          </div>
          <div className="flex gap-2">
            <button className="px-3 py-2 bg-gray-200 rounded" onClick={()=>{ setShop(null); }}>Logout</button>
            <button className="px-3 py-2 bg-amber-200 rounded" onClick={()=>{ navigator.clipboard?.writeText(JSON.stringify({ USE_MOCK, API_BASE })); alert('Config copied') }}>Copy config</button>
          </div>
        </div>

        <div className="grid grid-cols-3 gap-6">
          <div className="col-span-2">
            <Inventory shop={shop} onInventoryChange={list=>setInventoryList(list)} />
          </div>
          <div>
            <Sales shop={shop} onSaleRecorded={loadReport} />
            <div className="mt-4 bg-white p-4 rounded-2xl shadow">
              <h4 className="font-semibold">Today's summary</h4>
              {report ? (
                <div className="mt-2 text-sm text-gray-700">Total qty: <b>{report.total_qty || 0}</b><br/>Amount: <b>{report.total_amount || 0}</b></div>
              ) : <div className="text-gray-500">Loading...</div>}
              <div className="mt-3 text-xs text-gray-500">Data stored in {USE_MOCK ? 'localStorage (mock)' : 'backend API'}</div>
            </div>
          </div>
        </div>

        <div className="mt-6 text-sm text-gray-500">Tip: Set <code>USE_MOCK=false</code> and <code>API_BASE</code> to connect a real backend (same endpoints as server example).</div>
      </div>
    </div>
  );
}
